# Postmortem for medium severity bug identified on May 24, 2022.

## Reference 

This bug was stumbled upon by 0xSTVG and confirmed by Jango in a Discord message here: https://discord.com/channels/775859454780244028/876252266594721873/978704562540122172 (Screenshots attached at the bottom).

The Pull Request that fixes the bug can be found here: https://github.com/jbx-protocol/juice-contracts-v2/pull/265

## Severity 

No funds were immediately at risk. The bug made it possible for projects to end up in an unexpected funding cycle state, which would interrupt regular treasury operating behavior and allow projects to bypass funding cycle duration constraints.

## Behavior

To recreate the bug, follow these steps:

* Configure a funding cycle (FC#N) with a duration.
* Let the FC#N rollover to another funding cycle (FC#N+1). this step is necessary.
* Send a transaction to reconfigure the next funding cycle (FC#N+2) before FC#N+1 expires.
* Send another transaction to reconfigure the next funding cycle (FC#N+2) before FC#N+1 expires.

The expected behavior is that FC#N+1 is still the current funding cycle (`JBFundingCycleStore.getCurrentOf(...)`), and that the queued funding cycle is the latest configuration of FC#N+2 (`JBFundingCycleStore.getQueuedOf(...)`).

The unexpected behavior that takes affect is that the first reconfiguration of FC#N+2 immediately becomes the current funding cycle (`JBFundingCycleStore.getCurrentOf(...)`) once the second reconfiguration transaction succeeds.

## Specifics

The bug was caused by the lack of an `OR` condition in an `if` statement in the `_configureIntrinsicPropertiesFor` of the `JBFundingCycleStore`. See this pull request for the code specifics and accompanying added tests https://github.com/jbx-protocol/juice-contracts-v2/pull/265.

## Recourse

A new `JBFundingCycleStore` was deployed on May 25, 2022. All contracts that dependend on the old `JBFundingCycleStore` or upstream dependencies were also redeployed, including `JBDirectory`, `JBController`, `JBETHPaymentTerminal`, and `JBSingleTokenPaymentTerminalStore`, `JBSplitsStore`, and `JBTokenStore`.

Projects do not have to re-mint their ERC721 instance in `JBProjects`, nor do they have to re-issue their ERC-20 tokens. Projects can move their already-issued ERC20's from the old `JBTokenStore` to the new `JBTokenStore` using `JBTokenStore.changeFor(...)` transactions as follows:

* On the old `JBTokenStore`, call `changeFor(...)` with no new token (empty address), and the address of the new `JBTokenStore` as the `_newOwner`.
* On the new `JBTokenStore`, call `changeFor(...)` passing the token's address.

Projects thus have to re-instantiate their funding cycles, and re-distribute tokens to their holders. They can re-instantiate their funding cycles as follows:

* On the new `JBController`, call `launchFundingCyclesFor(...)` with the desired funding cycle properties along with the address of the new `JBETHPaymentTerminal` where funds will now be accepted.

Projects can re-distribute tokens to their holders as follows:

* While following the steps above to re-instantiate funding cycles, begin with a funding cycle with no duration that allows token minting.
* Mint a batch of tokens commensurate to sum of tokens that should be distributed to previous holders.
  * If a project's ERC-20 are being ported over using the `changeFor(...)` strategy described above, do not include ERC-20 balances in this calculation. Only include unclaimed balances as the ERC-20 balance will carry over once ported.
* Distribute the tokens to previous holders manually, via an airdrop, or via a 1:1 exchange. 
* Reconfigure the project's funding cycle as desired. 

